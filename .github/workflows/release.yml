name: Release

on:
  release:
    types: [published]

jobs:
  build-release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Extract and validate version from tag
      id: version
      run: |
        TAG="${{ github.event.release.tag_name }}"
        VERSION="${TAG#v}"
        if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
          echo "Error: version '$VERSION' is not valid semver (expected X.Y.Z)"
          exit 1
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build release JAR
      run: xvfb-run make install-release VERSION=${{ steps.version.outputs.version }}

    - name: Upload JAR to release
      run: |
        gh release upload "${{ github.event.release.tag_name }}" \
          "target/open-cyweb-${{ steps.version.outputs.version }}.jar" \
          --clobber
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
